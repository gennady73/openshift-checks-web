{% extends 'home/base.html' %}

{% block title %}Flask App - Block 1{% endblock %}

{% block head %}
    {{ super() }}
<div style="padding-top: 61px;"></div>
{% endblock %}


{% block content_special %}
<script>

    $(document).ready(function () {

        $('#cluster_config_table input[type="checkbox"]').on('change', function() {
            const checkedBoxes = $('#cluster_config_table input[type="checkbox"]:checked');
            $('#editCredential, #deleteCredential').prop('disabled', checkedBoxes.length !== 1);
            $('#createCredential, #createCredential').prop('disabled', checkedBoxes.length > 0);
        });

        $('#createCredential').on('click', function() {
            var modal = $('#credentialsModal');
            modal.find('input[name="id"]').val('');
            modal.find('input[name="name"]').val('');
            modal.find('input[name="server"]').val('');
            modal.find('input[name="token"]').val('');
            modal.find('input[name="user"]').val('');
            modal.find('input[name="namespace"]').val('');
            modal.find('input[name="insecure"]').prop('checked', false);
            modal.find('input[name="sa"]').val('');
        });

        $('#editCredential').on('click', function() {
            const selected = $('#cluster_config_table  tbody :checkbox:checked').closest('tr').find(':checkbox')

            var rowData = $(selected).data('json');
            // Assuming rowData is a JSON string, parse it
            rowData = rowData.replace(/'/g, '"');
            rowData = rowData.replace(/True/g, '"True"');
            rowData = rowData.replace(/False/g, '"False"');
            rowData = rowData.replace(/None/g, '"None"');

            var data = JSON.parse(rowData);

            var modal = $('#updateCredentialsModal');
            modal.find('input[name="id"]').val(data.id);
            modal.find('input[name="name"]').val(data.name);
            modal.find('input[name="server"]').val(data.server);
            modal.find('input[name="token"]').val(data.token);
            modal.find('input[name="user"]').val(data.user);
            modal.find('input[name="namespace"]').val(data.namespace);
            modal.find('input[name="insecure"]').prop('checked', data.insecure);
            modal.find('input[name="sa"]').val(data.sa);

            //modal.modal('show');
        });

        $('#deleteCredential').on('click', function() {
            const selected = $('#cluster_config_table  tbody :checkbox:checked').closest('tr').find(':checkbox')
            var rowData = $(selected).data('json');

            // Assuming rowData is a JSON string, parse it
            rowData = rowData.replace(/'/g, '"');
            rowData = rowData.replace(/True/g, '"True"');
            rowData = rowData.replace(/False/g, '"False"');
            rowData = rowData.replace(/None/g, '"None"');

            var data = JSON.parse(rowData);

            var modal = $('#deleteCredentialsModal');
            modal.find('input[name="id"]').val(data.id);
            modal.find('input[name="name"]').val(data.name);
        });

    });
</script>
<!-- TAB NAV BEGIN -->
<div id="home-tab-nav" style="padding-top: 5px;">

    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="navigation">
        <li role="navigation" {% if active_tab2=="LastCheckResults" %}class="active" {% endif %}>
            <a href="{{ url_for('home') }}" role="tab">Last check results</a>
        </li>
        <li role="navigation" {% if active_tab2=="Settings" %}class="active" {% endif %}>
            <a href="{{ url_for('settings') }}" role="tab">Settings</a>
        </li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
        {% block content_special_nested %}
        <div role="tabpanel" class="tab-pane active" id="settings">
            </br>
            <div class="toolbar-pf-actions">

                <nav id="nav2">
                    <!-- trigger modal for creating a new credentials -->
                    <button type="button" class="btn btn-primary" id="createCredential" name="createCredential" data-toggle="modal" data-target="#credentialsModal">
                        Add new credential
                    </button>
                    <button type="button" class="btn btn-primary"  id="editCredential" name="editCredential" data-toggle="modal" data-target="#updateCredentialsModal" disabled>
                        Edit credential
                    </button>
                    <button type="button" class="btn btn-primary" id="deleteCredential" name="deleteCredential" data-toggle="modal" data-target="#deleteCredentialsModal" disabled>
                        Delete credential
                    </button>
                </nav>
                <div id="notification" class="notification">
                    {% with messages = get_flashed_messages() %}
                        {% if messages %}
                            {% for message in messages %}
                                <div class="flash-{{ message[1] }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
        </div>
        {% endblock content_special_nested %}
    </div>
</div>
<!-- TAB NAV END -->
{% endblock content_special %}

{% block content %}
<div>
<!--    <h1>Settings</h1>-->
    {# <p>Customize your scheduler settings here....</p>
    <!-- Add your settings content here -->
    <dl>
      {% for key, value in config_data.items() %}
        <dt>{{ key }} : {{ value }}</dt>
      {% endfor %}
    </dl> #}

     <table id="cluster_config_table" class="table table-striped table-bordered table-hover">
        <thead>
        <tr id="cluster_config_table_header">
            <th class="table-view-pf-select sorting_disabled" rowspan="1" colspan="1" aria-label="Select all rows">
                <label class="sr-only" for="selectAll">Select all rows</label>
                <input type="checkbox" id="selectAll" name="selectAll">
            </th>
            <th class="id">ID</th>
            <th class="name">cluster name</th>
            <th class="server">cluster API (URL)</th>
            <th class="token">token</th>
            <th class="user">user name</th>
            <th class="namespace">namespace</th>
            <th class="insecure">Skip TLS verify</th>
            <th class="sa">Service Account</th>
        </tr>
        </thead>

         <tbody id=cluster_config_table_body" style>
                {% set i = 0 %}
                {% for cluster in cluster_info_list %}
                {% set i = loop.index %}
                <tr class="list-group list-view-pf list-view-pf-view">
                    <td class=" table-view-pf-select">
                        <label class="sr-only" for="select{{ i }}">Select cluster {{ i }}</label>
                        <input type="checkbox" id="select{{ i }}" name="select{{ i }}" aria-label="select{{ i }}"  data-json="{{ cluster }}">
                    </td>
                    <td>
                        <a title="Cluster details" href="{{ url_for('cluster_info', cluster_id=cluster.id) }}">{{ cluster.id }}</a>
                    </td>
                    <td>{{ cluster.name }}</td>
                    <td>{{ cluster.server }}</td>
                    <td>{{ cluster.token }}</td>
                    <td>{{ cluster.user }}</td>
                    <td>{{ cluster.namespace }}</td>
                    <td>{{ cluster.insecure }}</td>
                    <td>{{ cluster.sa }}</td>
                </tr>
                {% endfor %}
         </tbody>
     </table>
</div>

{# MODALS FOR TABLE OPERATIONS #}
{# CREATE #}
<div class="modal fade" id="credentialsModal" tabindex="-1" role="dialog" aria-labelledby="credentialsModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="create-credentials-form" method="post" title="create">
        <div class="modal-header">
          <h4 class="modal-title" id="credentialsModalLabel">Create Credentials</h4>
        </div>
        <div class="modal-body">
            <input type="hidden" name="action" value="create" />
          <div class="form-group"><label>Cluster Name</label><input class="form-control" name="name" required></div>
          <div class="form-group"><label>API Server</label><input class="form-control" name="server" required></div>
          <div class="form-group"><label>Token</label><input class="form-control" name="token"></div>
          <div class="form-group">
              <label>Certificate</label>
              <textarea class="form-control" name="certificate" rows="5" style="min-width: 550px;"></textarea>
          </div>
          <div class="form-group"><label>User</label><input class="form-control" name="user"></div>
          <div class="form-group"><label>Namespace</label><input class="form-control" name="namespace"></div>
          <div class="checkbox"><label><input type="checkbox" name="insecure"> Skip TLS Verify</label></div>
          <div class="form-group"><label>Service Account</label><input class="form-control" name="sa"></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Create</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# UPDATE #}
<div class="modal fade" id="updateCredentialsModal" tabindex="-1" role="dialog" aria-labelledby="updateCredentialsModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="update-credentials-form" method="post" title="update">
        <div class="modal-header">
          <h4 class="modal-title" id="updateCredentialsModalLabel">Edit Credentials</h4>
        </div>
        <div class="modal-body">
            <input type="hidden" name="action" value="update" />
            <input type="hidden" name="id" />
          <div class="form-group"><label>Cluster Name</label><input class="form-control" name="name" required></div>
          <div class="form-group"><label>API Server</label><input class="form-control" name="server" required></div>
          <div class="form-group"><label>Token</label><input class="form-control" name="token"></div>
          <div class="form-group">
              <label>Certificate</label>
              <textarea class="form-control" name="certificate" rows="5" style="min-width: 550px;"></textarea>
          </div>
          <div class="form-group"><label>User</label><input class="form-control" name="user"></div>
          <div class="form-group"><label>Namespace</label><input class="form-control" name="namespace"></div>
          <div class="checkbox"><label><input type="checkbox" name="insecure"> Skip TLS Verify</label></div>
          <div class="form-group"><label>Service Account</label><input class="form-control" name="sa"></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Update</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# DELETE #}
<div class="modal fade" id="deleteCredentialsModal" tabindex="-1" role="dialog" aria-labelledby="deleteCredentialsModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="delete-credentials-form" method="post" title="delete">
        <div class="modal-header">
          <h4 class="modal-title" id="deleteCredentialsModalLabel">Delete Credentials</h4>
        </div>
        <div class="modal-body">
              <input type="hidden" name="action" value="update" />
            <input type="hidden" name="id" />
          <div class="form-group"><label>Cluster Name</label><input class="form-control" name="name" required readonly></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Delete</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}
